{% if jekyll.environment == "production" and site.analytics.google.id %}
<script>
// --- Consent Mode v2: default "denied" (no pings/cookies) ---
window.dataLayer = window.dataLayer || [];
function gtag(){ dataLayer.push(arguments); }

// Set default no-consent (EU) â€“ before anything loads
gtag('consent', 'default', {
  'ad_storage': 'denied',
  'analytics_storage': 'denied',
  'ad_user_data': 'denied',
  'ad_personalization': 'denied',
  'wait_for_update': 500
});

// --- Strict blocking loader: loads gtag only after consent ---
function loadGtag(id) {
  if (window._ga_loaded) return;
  window._ga_loaded = true;

  var s = document.createElement('script');
  s.async = true;
  s.src = 'https://www.googletagmanager.com/gtag/js?id=' + encodeURIComponent(id);
  document.head.appendChild(s);

  gtag('js', new Date());
  // In GA4 anonymize_ip is unnecessary
  gtag('config', id);
}

// Simple consent cookie handling (consider a CMP with consent logging)
function getConsent() {
  const m = document.cookie.match(/(?:^|;\s*)cookie_consent=([^;]+)/);
  try { return m ? JSON.parse(decodeURIComponent(m[1])) : null; } catch { return null; }
}
function setConsent(obj) {
  const val = encodeURIComponent(JSON.stringify(obj));
  // CNIL (France) recommends 6 months
  document.cookie = 'cookie_consent=' + val + '; path=/; max-age=' + (60*60*24*180) + '; SameSite=Lax';
}

// Call from the banner after accepting analytics
window.enableAnalytics = function() {
  // 1) Consent signal to Google (Consent Mode v2)
  gtag('consent', 'update', {
    'analytics_storage': 'granted'
  });
  // 2) Save consent (with timestamp/policy version)
  setConsent({
    analytics: 'granted',
    ts: Date.now(),
    policy_version: '1.0'
  });
  // 3) Load GA
  loadGtag('{{ site.analytics.google.id }}');
};

// Decline (or withdraw consent)
window.disableAnalytics = function() {
  gtag('consent', 'update', {
    'analytics_storage': 'denied',
    'ad_storage': 'denied',
    'ad_user_data': 'denied',
    'ad_personalization': 'denied'
  });
  // Remove local consent
  document.cookie = 'cookie_consent=; path=/; max-age=0; SameSite=Lax';

  // Remove GA cookies (try both: hostname and top-level domain)
  ['_ga','_ga_'+('{{ site.analytics.google.id }}'.split('-').slice(1).join('-'))].forEach(function(name){
    document.cookie = name + '=; Max-Age=0; path=/; SameSite=Lax';
    document.cookie = name + '=; Max-Age=0; path=/; domain=.' + location.hostname + '; SameSite=Lax';
  });
};

// Auto-start if consent was previously given
(function initFromStoredConsent() {
  var c = getConsent();
  if (c && c.analytics === 'granted') {
    // signal 'granted' before we load gtag
    gtag('consent', 'update', { 'analytics_storage': 'granted' });
    loadGtag('{{ site.analytics.google.id }}');
  }
})();
</script>
{% endif %}
